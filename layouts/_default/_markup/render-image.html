{{- $src := ( .Destination | safeURL ) -}}
<figure>
  <picture>

    {{/* If the image is external, we provide a basic <img> tag. */}}
    {{- if strings.HasPrefix $src "http" -}}
      <img class="image_figure image_external" loading="lazy" src="{{ .Destination | safeURL }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}" {{ end }} />

      {{/* Provide caption based on image title, if it exists. */}}
      {{ if (.Title) -}}
        <figcaption>{{ .Title | safeHTML }}</figcaption>
      {{- end }}

    {{/* Otherwise, we add modern image formats (AVIF, WebP), if they exist. */}}
    {{/* This does not create these images, it only checks if they're present. */}}
    {{- else -}}

      {{ range $ext := (slice "avif" "webp" "jxl") }}
      {{ $dotext := print "." $ext }}
      {{ $path := replace .Destination ".png" $dotext }}
      {{ $path = replace $path ".jpg" $dotext }}
      {{ $path = replace $path ".jpeg" $dotext }}
      {{ $path = replace $path ".gif" $dotext }}
      {{ $path = imageConfig (add (add "/content/" .Page.File.Dir) .Destination) }}
        {{ if fileExists $path }}
          <source srcset="{{ $path | safeURL }}" type="image/{{ $ext }}">
        {{ end }}
      {{ end }}

      {{/* Original image, for fallback (IE). */}}
      {{ $img := imageConfig (add (add "/content/" .Page.File.Dir) .Destination) }}
      <img class="image_figure image_external" src="{{ .Destination | safeURL }}" alt="{{ .Text }}" loading="lazy" decoding="async" width="{{ $img.Width }}" height="{{ $img.Height }}" {{ with .Title}} title="{{ . }}" {{ end }} />

      {{/* Provide caption based on image title, if it exists. */}}
      {{ if (.Title) -}}
        <figcaption>{{ .Title | safeHTML }}</figcaption>
      {{- end }}

    {{- end -}}
  </picture>
</figure>
